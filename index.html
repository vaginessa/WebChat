<!DOCTYPE html>
<html>
	<head>
		<title>Webchat</title>
		<link rel="stylesheet" href="/style.css">
	</head>
	<body>
		<div id="nameSelectorPopup"></div>



		<div id="receiveMessageContainer"></div>

		<div id="sendMessageContainer">
			<textarea id="inputBox"></textarea>
			<div id="sendButton">Send</div>
		</div>

		<script src="/socket.io/socket.io.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.6/marked.min.js"
                integrity="sha256-mJAzKDq6kSoKqZKnA6UNLtPaIj8zT2mFnWu/GSouhgQ=" crossorigin="anonymous"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function() {

                if (!Notification) {
                    alert('Desktop notifications not available in your browser. Try Chromium.');
                    return;
                } else if (Notification.permission !== "granted") {
                    Notification.requestPermission();
                }

                var socket = io();
                var username;

                do {
                    username = prompt("What is your name?");
                } while (!username);
                socket.emit("chatMessage", {username: username, message: " is now online!", isMetaMessage: true});

                var receiveMessageContainer = document.getElementById("receiveMessageContainer");
                var inputBox = document.getElementById("inputBox");
                var sendButton = document.getElementById("sendButton");

                inputBox.focus(); // put cursor directly into inputBox
                inputBox.addEventListener("keydown", function(key) { // check for enter/shift+enter
                    if (key.keyCode === 13 && !key.shiftKey) {
                        submitMessage(key); // send message only if enter and not shift is pressed
                    }
                });

                sendButton.addEventListener("click", function(event) {
                    submitMessage(event); // send message if send button was clicked
                });

                socket.addEventListener("loadMessages", function(messageList) {
                    for (var i = 0; i < messageList.length; i++) {
                        displayText(messageList[i]);
                    }
                });

                window.onbeforeunload = function(event) {
                    socket.emit("chatMessage", {username: username, message: " is now offline.", isMetaMessage: true});
                };


                var submitMessage = function(event) {
                    var message = inputBox.value;

                    if (message.trim().length > 0) {
                        inputBox.value = "";
                        console.log(message);
                        socket.emit("chatMessage", {username: username, message: message});
                    }
                    event.preventDefault();
                };


                function notify(text) {
                    var notification = new Notification("Webchat", {
                        body: text
                    });
                    setTimeout(function() {
                        notification.close();
                    }, 2000);
                    notification.onclick = function() {
                        window.focus();
                        notification.close();
                    };
                }

                socket.addEventListener("receiveMessage", function(message) {
                    displayText(message);
                    notify(message.username + ": " + message.message);
                });

                socket.addEventListener("userDisconnect", function() {
                    //displayText(username + " is now offline.");
                    notify("Offline!");
                });

                function displayText(message) {
                    var receiveBox = document.getElementById("receiveMessageContainer");
                    var div = document.createElement("div");

                    var spanUsername = document.createElement("span");
                    var spanMessage = document.createElement("span");
                    spanUsername.classList.add("usernameDisplay");
                    spanMessage.classList.add("messageDisplay");
					
					var appendix;
                    if (message.isMetaMessage) {
						appendix = " "
                        div.classList.add("metaMessage");
                    } else {
						appendix = ":"
                    }
                    spanUsername.textContent = message.username + appendix;
                    spanMessage.innerHTML = marked(message.message, {
                            sanitize: true,
                            smartypants: true
                        });
                    div.appendChild(spanUsername);
                    div.appendChild(spanMessage);
                    receiveBox.appendChild(div);
                    div.scrollIntoView();
                }
            }, false);
		</script>
	</body>
</html>